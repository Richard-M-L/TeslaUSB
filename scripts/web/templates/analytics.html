{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/analytics.css') }}">

<div class="container">
    <h2>ğŸ“Š å­˜å‚¨åˆ†æä»ªè¡¨æ¿</h2>
    <div class="status-label {{ mode_class }}">å½“å‰æ¨¡å¼: {{ mode_label }}</div>

    <!-- Storage Health Status -->
    {% set health = analytics.storage_health %}
    {% if health.status == 'critical' %}
        <div class="alert alert-critical">
            <strong>âš ï¸ è­¦å‘Šï¼šå­˜å‚¨ç©ºé—´ä¸¥é‡ä¸è¶³ï¼</strong>
            {% for alert in health.alerts %}
                <div>{{ alert }}</div>
            {% endfor %}
        </div>
    {% elif health.status == 'warning' %}
        <div class="alert alert-warning">
            <strong>âš ï¸ å­˜å‚¨è­¦å‘Š</strong>
            {% for alert in health.alerts %}
                <div>{{ alert }}</div>
            {% endfor %}
        </div>
    {% else %}
        <div class="alert alert-success">
            <strong>âœ… å­˜å‚¨å¥åº·</strong>
        </div>
    {% endif %}

    <!-- Storage Management Actions -->
    <div class="management-actions">
        <a href="{{ url_for('cleanup.settings') }}" class="action-card">
            <div class="action-icon">ğŸ§¹</div>
            <div class="action-content">
                <h3>è‡ªåŠ¨æ¸…ç†è®¾ç½®</h3>
                <p>é…ç½®è‡ªåŠ¨åˆ é™¤æ—§è§†é¢‘çš„åŠŸèƒ½ï¼Œä»¥é‡Šæ”¾å­˜å‚¨ç©ºé—´ã€‚</p>
            </div>
            <div class="action-arrow">â†’</div>
        </a>
    </div>

    <!-- Filesystem Health Check Section -->
    <div class="analytics-section fsck-section">
        <h3>ğŸ” æ–‡ä»¶ç³»ç»Ÿå¥åº·æ£€æŸ¥</h3>
        <p class="section-description">
            è¿è¡Œæ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥ä»¥æ£€æµ‹å’Œä¿®å¤æŸåã€‚<br>
            <small><strong>å¿«é€Ÿæ£€æŸ¥ï¼š</strong> å¯ä»¥åœ¨ä»»ä½•æ¨¡å¼ä¸‹è¿è¡Œï¼ˆåªè¯»æ¨¡å¼ï¼Œ30åˆ†é’Ÿè¶…æ—¶ï¼‰ã€‚ | <strong>ä¿®å¤ï¼š</strong> éœ€è¦è¿›å…¥ç¼–è¾‘æ¨¡å¼ï¼ˆä¿®å¤é”™è¯¯ï¼Œè¶…æ—¶æ—¶é—´ä¸º2å°æ—¶ï¼‰</small>
        </p>

        <div class="fsck-status-container" id="fsck-status-container">
            <!-- Dynamic status will be loaded here -->
        </div>

        <div class="fsck-partitions">
            <div class="fsck-partition-card">
                <h4>ğŸ“¹ è¡Œè½¦è®°å½•ä»ªæ–‡ä»¶å¤¹(TeslaCam)</h4>
                <div id="part1-last-check" class="last-check-info">ç­‰å¾…...</div>
                <div class="fsck-actions">
                    <button onclick="startFsck(1, 'quick')" class="btn btn-secondary" id="btn-fsck-part1-quick">
                        å¿«é€Ÿæ£€æŸ¥
                    </button>
                    <button onclick="startFsck(1, 'repair')" class="btn btn-warning" id="btn-fsck-part1-repair">
                        æ£€æŸ¥å¹¶ä¿®å¤
                    </button>
                </div>
            </div>

            <div class="fsck-partition-card">
                <h4>ğŸ’¡ ç¯å…‰ç§€æ–‡ä»¶å¤¹(LightShow)</h4>
                <div id="part2-last-check" class="last-check-info">ç­‰å¾…...</div>
                <div class="fsck-actions">
                    <button onclick="startFsck(2, 'quick')" class="btn btn-secondary" id="btn-fsck-part2-quick">
                        å¿«é€Ÿæ£€æŸ¥
                    </button>
                    <button onclick="startFsck(2, 'repair')" class="btn btn-warning" id="btn-fsck-part2-repair">
                        æ£€æŸ¥å¹¶ä¿®å¤
                    </button>
                </div>
            </div>
        </div>

        <div id="fsck-history-container" class="fsck-history-container">
            <h4>è¿‘æœŸæ£€æŸ¥</h4>
            <div class="fsck-history-scroll">
                <div id="fsck-history-list">ç­‰å¾…...</div>
            </div>
        </div>
    </div>

    <!-- Drive Usage Cards -->
    <div class="analytics-grid">
        {% for partition_name, usage in analytics.partition_usage.items() %}
        <div class="analytics-card">
            <h3>{{ 'ğŸ“¹ è¡Œè½¦è®°å½•ä»ªæ–‡ä»¶å¤¹(TeslaCam)' if partition_name == 'part1' else 'ğŸ’¡ ç¯å…‰ç§€æ–‡ä»¶å¤¹(LightShow)' }}</h3>

            {% if 'error' in usage %}
                <div class="error-message">{{ usage.error }}</div>
            {% else %}
                <div class="usage-stats">
                    <div class="stat-row">
                        <span class="stat-label">æ€»ç©ºé—´:</span>
                        <span class="stat-value">{{ "%.2f"|format(usage.total_gb) }} GB</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">å·²ä½¿ç”¨:</span>
                        <span class="stat-value">{{ "%.2f"|format(usage.used_gb) }} GB</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">ç©ºé—²:</span>
                        <span class="stat-value">{{ "%.2f"|format(usage.free_gb) }} GB</span>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="progress-container">
                    <div class="progress-bar
                        {% if usage.percent_used >= 95 %}progress-critical
                        {% elif usage.percent_used >= 90 %}progress-warning
                        {% elif usage.percent_used >= 80 %}progress-caution
                        {% else %}progress-normal{% endif %}"
                         style="width: {{ usage.percent_used }}%">
                    </div>
                </div>
                <div class="progress-label">{{ "%.1f"|format(usage.percent_used) }}% å·²ä½¿ç”¨</div>

                <div class="partition-path">{{ usage.path }}</div>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <!-- Recording Time Estimate -->
    {% set estimate = analytics.recording_estimate %}
    {% if estimate.teslacam_hours is not none %}
    <div class="info-card">
        <h3>â±ï¸ é¢„è®¡å‰©ä½™å½•åˆ¶æ—¶é—´</h3>
        <div class="estimate-value">
            {% if estimate.teslacam_hours >= 24 %}
                {{ "%.1f"|format(estimate.teslacam_hours / 24) }} å¤©
            {% elif estimate.teslacam_hours >= 1 %}
                {{ "%.1f"|format(estimate.teslacam_hours) }} å°æ—¶
            {% else %}
                {{ "%.0f"|format(estimate.teslacam_hours * 60) }} åˆ†é’Ÿ
            {% endif %}
        </div>
        <div class="estimate-method">{{ estimate.method }}</div>
        <div class="estimate-confidence">ç»“æœçš„å¯ä¿¡åº¦: {{ estimate.confidence }}</div>
    </div>
    {% endif %}

    <!-- Video Statistics -->
    <div class="analytics-section">
        <h3>ğŸ“¹ è§†é¢‘ç»Ÿè®¡</h3>

        {% set video_stats = analytics.video_statistics %}
        <div class="totals-row">
            <div class="total-stat">
                <div class="total-number">{{ video_stats.totals.total_videos }}</div>
                <div class="total-label">è§†é¢‘æ€»æ•°</div>
            </div>
            <div class="total-stat">
                <div class="total-number">{{ "%.2f"|format(video_stats.totals.total_size_gb) }} GB</div>
                <div class="total-label">æ€»å¤§å°</div>
            </div>
        </div>
    </div>

    <!-- Folder Breakdown -->
    {% if analytics.folder_breakdown %}
    <div class="analytics-section">
        <h3>ğŸ“ è§†é¢‘æ–‡ä»¶å¤¹æ¦‚è§ˆ</h3>

        <div class="folder-table-container">
            <table class="analytics-table" style="table-layout: fixed; width: 100%;">
                <thead>
                    <tr>
                        <th style="width: 30%;">æ–‡ä»¶å¤¹åç§°</th>
                        <th style="width: 10%;text-align: center;">è§†é¢‘æ•°é‡</th>
                        <th style="width: 10%;text-align: center;">å ç”¨</th>
                        <th style="width: 20%;text-align: center;">æ€»å æ¯”</th>
                        <th style="width: 15%;text-align: center;">æœ€æ—©åˆ›å»º</th>
                        <th style="width: 15%;text-align: center;">æœ€æ–°åˆ›å»º</th>
                    </tr>
                </thead>
                <tbody>
                    {% for folder in analytics.folder_breakdown %}
                    <tr class="priority-{{ folder.priority }}">
                        <td style="padding: 12px 10px;">
                            <span class="folder-icon">{{ folder.icon }}</span>
                            <strong>{{ folder.name }}</strong>
                            <div class="folder-description" style="font-size: 0.85em; color: #888; margin-top: 4px;">{{ folder.description }}</div>
                        </td>
                        <td class="number-cell" style="text-align: center;">{{ folder.count }}</td>
                        <td class="number-cell" style="text-align: center;">{{ "%.2f"|format(folder.size_gb) }} GB</td>
                        <td class="number-cell" style="text-align: center;">
                            <div class="mini-progress-container" style="margin: 0 auto; width: 80%;">
                                <div class="mini-progress-bar" style="width: {{ folder.size_percent }}%">
                                </div>
                            </div>
                            <div style="margin-top: 4px;">
                                {{ "%.1f"|format(folder.size_percent) }}%
                            </div>
                        </td>
                        <td class="date-cell" style="text-align: center;">{{ folder.oldest or 'N/A' }}</td>
                        <td class="date-cell" style="text-align: center;">{{ folder.newest or 'N/A' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        

        
        <!-- Mobile Card Layout -->
        <div class="folder-cards-mobile">
            {% for folder in analytics.folder_breakdown %}
            <div class="folder-card priority-{{ folder.priority }}">
                <div class="folder-card-header">
                    <span class="folder-icon-large">{{ folder.icon }}</span>
                    <div>
                        <strong>{{ folder.name }}</strong>
                        <div class="folder-description">{{ folder.description }}</div>
                    </div>
                </div>
                <div class="folder-card-stats">
                    <div class="folder-stat">
                        <span class="folder-stat-label">è§†é¢‘æ•°é‡:</span>
                        <span class="folder-stat-value">{{ folder.count }}</span>
                    </div>
                    <div class="folder-stat">
                        <span class="folder-stat-label">å ç”¨:</span>
                        <span class="folder-stat-value">{{ "%.2f"|format(folder.size_gb) }} GB</span>
                    </div>
                    <div class="folder-stat">
                        <span class="folder-stat-label">æ€»å æ¯”:</span>
                        <span class="folder-stat-value">{{ "%.1f"|format(folder.size_percent) }}%</span>
                    </div>
                </div>
                <div class="folder-card-dates">
                    <div><small>æœ€æ—©åˆ›å»º: {{ folder.oldest or 'N/A' }}</small></div>
                    <div><small>æœ€æ–°åˆ›å»º: {{ folder.newest or 'N/A' }}</small></div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Recommendations -->
    {% if health.recommendations %}
    <div class="recommendations-section">
        <h3>ğŸ’¡ æ¨è</h3>
        <ul class="recommendations-list">
            {% for recommendation in health.recommendations %}
            <li>{{ recommendation }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- Last Updated -->
    <div class="last-updated">
        æœ€åæ›´æ–°æ—¶é—´: {{ analytics.last_updated }}
        <button onclick="location.reload()" class="btn-refresh">ğŸ”„ åˆ·æ–°</button>
    </div>
</div>

<script>
// Filesystem check functionality
let fsckCheckInterval = null;
let currentMode = '{{ mode_token }}';

function startFsck(partition, mode) {
    // Repair requires edit mode, quick check can run in any mode
    if (mode === 'repair' && currentMode !== 'edit') {
        if (confirm('æ£€æŸ¥å’Œä¿®å¤åŠŸèƒ½éœ€è¦ç¼–è¾‘æ¨¡å¼ã€‚\n\næ‚¨æ˜¯å¦åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼ï¼Œè¿è¡Œä¿®å¤ç¨‹åºï¼Œç„¶åå†åˆ‡æ¢å›æ¥ï¼Ÿ')) {
            startFsckWithModeSwitch(partition, mode);
        }
        return;
    }

    // Start fsck directly
    executeFsck(partition, mode);
}

function executeFsck(partition, mode) {
    // Disable all buttons
    disableFsckButtons(true);

    fetch('/fsck/api/start', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            partition: partition,
            mode: mode
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showFsckStatus('æ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥å·²å¼€å§‹...', 'info');
            // Start polling for status
            startFsckStatusPolling();
        } else {
            showFsckStatus(data.message, 'error');
            disableFsckButtons(false);
        }
    })
    .catch(error => {
        showFsckStatus('å¯åŠ¨æ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥æ—¶å‡ºé”™ï¼š' + error, 'error');
        disableFsckButtons(false);
    });
}

function startFsckWithModeSwitch(partition, mode) {
    const originalMode = currentMode;
    const partitionName = partition === 1 ? 'TeslaCam' : 'LightShow';

    disableFsckButtons(true);
    showFsckStatus('æ­£åœ¨åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼...', 'info');

    // Step 1: Switch to edit mode
    fetch('/edit_usb', {
        method: 'POST'
    })
    .then(response => {
        if (!response.ok) throw new Error('åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼å¤±è´¥ã€‚');
        currentMode = 'edit';
        showFsckStatus(`ç¼–è¾‘æ¨¡å¼æ¿€æ´»ä¸­ - ç­‰å¾…æ¨¡å¼åˆ‡æ¢å®Œæˆ...`, 'info');

        // Wait for mode switch to fully complete (unmount gadget, remount RW)
        return new Promise(resolve => setTimeout(resolve, 3000));
    })
    .then(() => {
        showFsckStatus(`å¼€å§‹ ${partitionName} ä¿®å¤...`, 'info');

        // Step 2: Start fsck
        return fetch('/fsck/api/start', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                partition: partition,
                mode: mode
            })
        });
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showFsckStatus(`${partitionName} ä¿®å¤ä¸­...`, 'info');
            // Poll for completion, then restore mode
            startFsckStatusPollingWithRestore(originalMode);
        } else {
            throw new Error(data.message);
        }
    })
    .catch(error => {
        showFsckStatus('é”™è¯¯: ' + error.message, 'error');
        disableFsckButtons(false);
        // Try to restore original mode on error
        if (currentMode !== originalMode) {
            restoreMode(originalMode);
        }
    });
}

function startFsckStatusPollingWithRestore(originalMode) {
    if (fsckCheckInterval) {
        clearInterval(fsckCheckInterval);
    }

    const checkStatusAndRestore = () => {
        fetch('/fsck/api/status')
            .then(response => response.json())
            .then(status => {
                if (status.running) {
                    // Still running, update status
                    const progress = status.progress || 'æ­£åœ¨è¿è¡Œ...';
                    const elapsed = status.start_time ?
                        Math.round((new Date() - new Date(status.start_time)) / 1000) : 0;
                    const friendlyName = getFriendlyPartitionName(status.partition);
                    showFsckStatus(
                        `${friendlyName} - ${progress} (å·²ç”¨${elapsed}ç§’)`,
                        'info'
                    );
                } else {
                    // Fsck completed, restore mode
                    clearInterval(fsckCheckInterval);
                    fsckCheckInterval = null;

                    if (status.result) {
                        const resultClass = status.result === 'healthy' || status.result === 'repaired'
                            ? 'success' : 'warning';
                        const friendlyName = getFriendlyPartitionName(status.partition);
                        showFsckStatus(
                            `${friendlyName} - ${status.result}: ${status.details} (${status.duration}s) - æ¢å¤æ¨¡å¼...`,
                            resultClass
                        );
                    }

                    // Restore original mode
                    restoreMode(originalMode);
                    updateLastChecks();
                    updateFsckHistory();
                }
            })
            .catch(error => {
                console.error('æ£€æŸ¥æ–‡ä»¶ç³»ç»ŸçŠ¶æ€æ—¶å‡ºé”™ï¼š', error);
            });
    };

    checkStatusAndRestore();
    fsckCheckInterval = setInterval(checkStatusAndRestore, 2000);
}

function restoreMode(targetMode) {
    if (currentMode === targetMode) {
        disableFsckButtons(false);
        return;
    }

    const endpoint = targetMode === 'present' ? '/present_usb' : '/edit_usb';
    const modeName = targetMode === 'present' ? 'è½¦è½½Uç›˜æ¨¡å¼' : 'ç¼–è¾‘æ¨¡å¼';

    fetch(endpoint, {
        method: 'POST'
    })
    .then(response => {
        if (response.ok) {
            currentMode = targetMode;
            showFsckStatus(`æ¢å¤åˆ° ${modeName}`, 'success');
            setTimeout(() => {
                document.getElementById('fsck-status-container').style.display = 'none';
                disableFsckButtons(false);
            }, 3000);
        } else {
            throw new Error(`æ¢å¤ ${modeName}å¤±è´¥`);
        }
    })
    .catch(error => {
        showFsckStatus('æ¢å¤æ¨¡å¼å‡ºé”™: ' + error.message + ' - è¯·æ‰‹åŠ¨åˆ‡æ¢æ¨¡å¼', 'error');
        disableFsckButtons(false);
    });
}

function startFsckStatusPolling() {
    // Poll every 2 seconds
    if (fsckCheckInterval) {
        clearInterval(fsckCheckInterval);
    }

    updateFsckStatus(); // Update immediately
    fsckCheckInterval = setInterval(updateFsckStatus, 2000);
}

function getFriendlyPartitionName(partition) {
    if (partition === 'part1') return 'TeslaCam';
    if (partition === 'part2') return 'LightShow';
    return partition;
}

function updateFsckStatus() {
    fetch('/fsck/api/status')
        .then(response => response.json())
        .then(status => {
            if (status.running) {
                // Disable buttons while check is running
                disableFsckButtons(true);

                const progress = status.progress || 'æ­£åœ¨è¿è¡Œ...';
                const elapsed = status.start_time ?
                    Math.round((new Date() - new Date(status.start_time)) / 1000) : 0;
                const friendlyName = getFriendlyPartitionName(status.partition);
                showFsckStatus(
                    `${friendlyName} - ${progress} (å·²ç”¨${elapsed}ç§’)`,
                    'info'
                );

                // Ensure polling is active if not already
                if (!fsckCheckInterval) {
                    fsckCheckInterval = setInterval(updateFsckStatus, 2000);
                }
            } else {
                // Check completed or not running
                if (fsckCheckInterval) {
                    clearInterval(fsckCheckInterval);
                    fsckCheckInterval = null;
                }

                if (status.result) {
                    const resultClass = status.result === 'healthy' || status.result === 'repaired'
                        ? 'success' : 'warning';
                    const friendlyName = getFriendlyPartitionName(status.partition);
                    showFsckStatus(
                        `${friendlyName} - ${status.result}: ${status.details} (${status.duration}s)`,
                        resultClass
                    );
                    // Auto-hide completed status after 30 seconds
                    setTimeout(() => {
                        const container = document.getElementById('fsck-status-container');
                        if (container && !status.running) {
                            container.style.display = 'none';
                        }
                    }, 30000);
                } else {
                    // Hide status if no recent result
                    document.getElementById('fsck-status-container').style.display = 'none';
                }

                disableFsckButtons(false);
                updateLastChecks();
                updateFsckHistory();
            }
        })
        .catch(error => {
            console.error('æ£€æŸ¥æ–‡ä»¶ç³»ç»ŸçŠ¶æ€æ—¶å‡ºé”™:', error);
        });
}

function showFsckStatus(message, type) {
    const container = document.getElementById('fsck-status-container');
    container.style.display = 'block';
    container.className = 'fsck-status-container fsck-status-' + type;

    // Add cancel button if status is info (running)
    let cancelButton = '';
    if (type === 'info') {
        cancelButton = '<button onclick="cancelFsck()" class="btn-cancel-fsck">Cancel</button>';
    }

    container.innerHTML = `
        <div class="fsck-status-message">${message}</div>
        ${cancelButton}
    `;
}

function cancelFsck() {
    if (!confirm('æ‚¨ç¡®å®šè¦å–æ¶ˆæ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥å—ï¼Ÿ')) {
        return;
    }

    fetch('/fsck/api/cancel', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showFsckStatus('æ­£åœ¨å–æ¶ˆæ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥...', 'warning');
        } else {
            showFsckStatus('å–æ¶ˆå¤±è´¥: ' + data.message, 'error');
        }
    })
    .catch(error => {
        showFsckStatus('å–æ¶ˆæ£€æŸ¥æ—¶å‡ºé”™: ' + error, 'error');
    });
}

function disableFsckButtons(disabled) {
    document.querySelectorAll('.fsck-actions button').forEach(btn => {
        btn.disabled = disabled;
    });
}

function updateLastChecks() {
    [1, 2].forEach(partition => {
        fetch(`/fsck/api/last-check/${partition}`)
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById(`part${partition}-last-check`);
                if (data.timestamp) {
                    const date = new Date(data.timestamp);
                    const ageHours = data.age_hours || 0;
                    const ageStr = ageHours < 1 ? 'ä¸åˆ°ä¸€å°æ—¶å‰' :
                                   ageHours < 24 ? `${Math.round(ageHours)} å°æ—¶å‰` :
                                   `${Math.round(ageHours / 24)} å¤©å‰`;

                    const icon = data.result === 'healthy' ? 'âœ…' :
                                data.result === 'repaired' ? 'ğŸ”§' :
                                data.result === 'recording' ? 'ğŸ“¹' :
                                data.result === 'errors' ? 'âš ï¸' :
                                data.result === 'failed' ? 'âŒ' :
                                data.result === 'timeout' ? 'â±ï¸' : 'â“';

                    const statusClass = data.result === 'healthy' ? 'status-healthy' :
                                       data.result === 'repaired' ? 'status-repaired' :
                                       data.result === 'recording' ? 'status-recording' :
                                       data.result === 'errors' ? 'status-errors' :
                                       'status-warning';

                    container.innerHTML = `
                        <div class="last-check-result ${statusClass}">
                            ${icon} ä¸Šæ¬¡æ£€æŸ¥: ${ageStr}
                            <br><small>${data.details}</small>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div class="last-check-never">ä»æœªæ£€æŸ¥è¿‡</div>';
                }
            })
            .catch(error => {
                console.error(`åŠ è½½åˆ†åŒºä¸Šæ¬¡æ£€æŸ¥ç»“æœæ—¶å‡ºé”™ ${partition}:`, error);
            });
    });
}

function updateFsckHistory() {
    fetch('/fsck/api/history')
        .then(response => response.json())
        .then(history => {
            const container = document.getElementById('fsck-history-list');
            if (history.length === 0) {
                container.innerHTML = '<div class="no-history">ç›®å‰å°šæœªè®°å½•ä»»ä½•æ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥ä¿¡æ¯ã€‚</div>';
                return;
            }

            // Show last 5 entries
            const recent = history.slice(-5).reverse();
            let html = '<table class="fsck-history-table"><thead><tr>' +
                       '<th>æ—¶é—´</th><th>æ–‡ä»¶å¤¹</th><th>æ¨¡å¼</th><th>ç»“æœ</th><th>ç»†èŠ‚</th>' +
                       '</tr></thead><tbody>';

            recent.forEach(entry => {
                const date = new Date(entry.timestamp);
                const icon = entry.result === 'healthy' ? 'âœ…' :
                            entry.result === 'repaired' ? 'ğŸ”§' :
                            entry.result === 'recording' ? 'ğŸ“¹' :
                            entry.result === 'timeout' ? 'â±ï¸' :
                            entry.result === 'failed' ? 'âŒ' : 'â“';
                const friendlyPartition = getFriendlyPartitionName(entry.partition);

                html += `<tr>
                    <td>${date.toLocaleString()}</td>
                    <td>${friendlyPartition}</td>
                    <td>${entry.mode}</td>
                    <td>${icon} ${entry.result}</td>
                    <td><small>${entry.details}</small></td>
                </tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        })
        .catch(error => {
            console.error('åŠ è½½å†å²è®°å½•æ—¶å‡ºé”™:', error);
        });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updateLastChecks();
    updateFsckHistory();
    updateFsckStatus(); // Check if any check is currently running
});
</script>
{% endblock %}
