{% extends "base.html" %}
{% block content %}
<div class="container">
    <h2>ğŸ¨ å®šåˆ¶è½¦èº«è´´çº¸</h2>
    <div class="status-label {{ mode_class }}">å½“å‰æ¨¡å¼: {{ mode_label }}</div>

    <!-- iOS Safari Warning -->
    <div id="iosWarning" class="ios-warning">
        <p><strong>âš ï¸ iOSæµè§ˆå™¨é™åˆ¶:</strong> åœ¨ iOS ç³»ç»Ÿä¸Šï¼Œæ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ä»…æ”¯æŒé€šè¿‡ Safari æµè§ˆå™¨ä½¿ç”¨ã€‚è¯·åœ¨ Safari æµè§ˆå™¨ä¸­æ‰“å¼€æ­¤é¡µé¢ä»¥ä¸Šä¼ æ–‡ä»¶ã€‚</p>
        <p>æ³¨æ„ï¼šæ¡Œé¢æµè§ˆå™¨ï¼ˆWindows/Mac/Linuxï¼‰æ— è®ºé€‰æ‹©å“ªç§æµè§ˆå™¨éƒ½èƒ½æ­£å¸¸è¿è¡Œã€‚</p>
    </div>

    <!-- Tesla Requirements Info -->
    <div class="info-box" style="margin-bottom: 20px;">
        <p><strong>ğŸ“‹ ç‰¹æ–¯æ‹‰è½¦èº«è´´çº¸è¦æ±‚:</strong></p>
        <ul style="margin: 10px 0 0 20px; padding: 0; font-size: 13px; color: var(--text-secondary);">
            <li><strong>æ ¼å¼:</strong> ä»…é™PNGæ ¼å¼</li>
            <li><strong>å¤§å°:</strong> æœ€å¤§ {{ (max_file_size / 1024 / 1024)|round(0)|int }} MB </li>
            <li><strong>å°ºå¯¸:</strong> {{ min_dimension }}x{{ min_dimension }} è‡³ {{ max_dimension }}x{{ max_dimension }} åƒç´ </li>
            <li><strong>æ–‡ä»¶å:</strong> æœ€å¤š{{ max_filename_length }} ä¸ªå­—ç¬¦ (å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€ç ´æŠ˜å·ã€ç©ºæ ¼)</li>
            <li><strong>æ•°é‡:</strong> ä¸€æ¬¡æœ€å¤š {{ max_wrap_count }} ä¸ª (å½“å‰ï¼š {{ wrap_count }}/{{ max_wrap_count }})</li>
        </ul>
        <p style="margin-top: 10px; font-size: 13px; color: var(--text-secondary);">
            <strong>ä½¿ç”¨æ–¹æ³•:</strong> è´´çº¸ä¸Šä¼ åˆ°æ­¤é¡µé¢ â†’ ç©å…·ç®± â†’ å–·æ¼†è½¦é—´ â†’ è½¦è¾†è´´çº¸ç•Œé¢.
            <a href="https://github.com/teslamotors/custom-wraps" target="_blank" style="color: var(--text-link);">ä»ç‰¹æ–¯æ‹‰ä¸‹è½½æ¨¡æ¿</a>
        </p>
    </div>

    <div class="folder-controls" id="wrapUploadControls">
        <!-- Desktop Drag & Drop Interface -->
        <div id="desktopUploadInterface" style="display: none;">
            <div class="drag-drop-zone" id="dragDropZone" style="border: 3px dashed var(--border-input); border-radius: 8px; padding: 40px; text-align: center; background: var(--form-input-bg); cursor: pointer; transition: all 0.3s; margin-bottom: 20px;">
                <div style="pointer-events: none;">
                    <i class="bi bi-image" style="font-size: 48px; color: var(--btn-purple-bg); display: block; margin-bottom: 15px;"></i>
                    <p style="font-size: 16px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">å°† PNG æ–‡ä»¶æ‹–æ”¾åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»æ­¤å¤„æµè§ˆæ–‡ä»¶ã€‚</p>
                    <p style="font-size: 13px; color: var(--text-secondary); margin: 0;">
                        æ¯ä¸ªPNG æ–‡ä»¶åªæ”¯æŒ â€¢ {{ min_dimension }}è‡³{{ max_dimension }}åƒç´  â€¢ æœ€å¤§ 1 MBã€‚
                    </p>
                </div>
            </div>

            <input type="file" id="wrap_files_multi" accept=".png,image/png" multiple style="display: none;">

            <!-- Selected Files Preview -->
            <div id="selectedFilesPreview" style="display: none; margin-bottom: 20px;">
                <h4 style="margin: 0 0 10px 0; font-size: 15px; color: var(--text-primary);">ğŸ“‹ å¾…ä¸Šä¼ æ–‡ä»¶:</h4>
                <div id="filesList" style="background: var(--form-input-bg); border: 1px solid var(--border-input); border-radius: 4px; padding: 10px; max-height: 300px; overflow-y: auto;"></div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button type="button" class="edit-btn" id="uploadSelectedBtn">ğŸ“¤ ä¸Šä¼ å…¨éƒ¨æ–‡ä»¶</button>
                    <button type="button" class="btn-delete" id="clearSelectedBtn">âœ– å…¨éƒ¨æ¸…é™¤</button>
                </div>
            </div>
        </div>

        <!-- Mobile/Fallback Simple Upload Interface -->
        <form method="post" action="{{ url_for('wraps.upload_wrap') }}" enctype="multipart/form-data" style="margin-bottom: 20px;" id="wrapUploadForm">
            <label for="wrap_file" style="display: block; margin-bottom: 8px; font-weight: 600;">ä¸Šä¼ è‡ªå®šä¹‰è´´çº¸:</label>
            <p style="margin: 0 0 10px 0; font-size: 13px; color: var(--text-secondary);">
                PNG æ–‡ä»¶ â€¢ {{ min_dimension }}-{{ max_dimension }}åƒç´  â€¢ æœ€å¤§ 1 MB
            </p>
            <input type="file" name="wrap_file" id="wrap_file" accept=".png,image/png" required
                   style="display: block; margin-bottom: 10px; padding: 10px; border: 2px solid var(--border-input); border-radius: 4px; background: var(--form-input-bg); width: 100%; max-width: 400px; font-size: 14px; color: var(--text-primary);">
            <button type="submit" class="edit-btn" id="wrapUploadBtn">ğŸ“¤ ä¸Šä¼ </button>
        </form>
        <!-- Upload Progress Bar -->
        <div id="wrapUploadProgress" style="display: none; margin-bottom: 20px;">
            <div style="background: var(--upload-progress-bg); border-radius: 8px; padding: 15px; border: 2px solid var(--btn-purple-bg);">
                <h4 style="margin: 0 0 10px 0; color: var(--btn-purple-bg);">ğŸ“¤ ä¸Šä¼ è´´çº¸ä¸­...</h4>
                <div style="background: var(--upload-progress-bar-bg); border-radius: 4px; height: 30px; overflow: hidden; margin-bottom: 10px;">
                    <div id="wrapProgressBar" style="background: linear-gradient(90deg, #6f42c1, #5a32a3); height: 100%; width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;">
                        0%
                    </div>
                </div>
                <p id="wrapUploadStatus" style="margin: 0; font-size: 13px; color: var(--text-secondary);">æ­£åœ¨å‡†å¤‡ä¸Šä¼ ...</p>
            </div>
        </div>
    </div>

    {% if wrap_files %}
    <!-- Desktop Table Layout -->
    <div class="video-table-container">
        <table class="video-table" style="table-layout: fixed;">
            <thead>
                <tr>
                    <th style="width: 100px;">é¢„è§ˆ</th>
                    <th style="width: 30%;">æ–‡ä»¶å</th>
                    <th style="width: 20%;">å°ºå¯¸</th>
                    <th style="width: 15%;">æ–‡ä»¶å¤§å°</th>
                    <th style="width: 25%;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for wrap in wrap_files %}
                <tr>
                    <td>
                        <div class="wrap-thumbnail-container">
                            <img src="{{ url_for('wraps.wrap_thumbnail', partition=wrap.partition_key, filename=wrap.filename) }}"
                                 alt="{{ wrap.filename }}"
                                 class="wrap-thumbnail"
                                 loading="lazy">
                        </div>
                    </td>
                    <td style="word-wrap: break-word; overflow-wrap: break-word;">{{ wrap.filename }}</td>
                    <td>{{ wrap.dimensions }}</td>
                    <td>{{ wrap.size_str }}</td>
                    <td>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                            <a href="{{ url_for('wraps.download_wrap', partition=wrap.partition_key, filename=wrap.filename) }}"
                               class="action-btn btn-success">
                                ğŸ“¥ ä¸‹è½½
                            </a>
                            <form method="post" action="{{ url_for('wraps.delete_wrap', partition=wrap.partition_key, filename=wrap.filename) }}" style="display: inline; margin: 0;"
                                  onsubmit="return confirm('æ‚¨ç¡®å®šè¦åˆ é™¤ {{ wrap.filename }}å—ï¼Ÿ');">
                                <button type="submit" class="action-btn btn-danger">ğŸ—‘ï¸ åˆ é™¤</button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Mobile Card Layout for Wraps -->
    <div class="mobile-card-container">
        {% for wrap in wrap_files %}
        <div class="mobile-card wrap-card">
            <div class="wrap-thumbnail-container-mobile">
                <img src="{{ url_for('wraps.wrap_thumbnail', partition=wrap.partition_key, filename=wrap.filename) }}"
                     alt="{{ wrap.filename }}"
                     class="wrap-thumbnail-mobile"
                     loading="lazy">
            </div>
            <div class="mobile-card-title">
                <strong>{{ wrap.filename }}</strong>
            </div>
            <div class="mobile-card-info">
                <div class="mobile-card-info-row">
                    <span class="mobile-card-info-label">Dimensions:</span>
                    <span class="mobile-card-info-value">{{ wrap.dimensions }}</span>
                </div>
                <div class="mobile-card-info-row">
                    <span class="mobile-card-info-label">Size:</span>
                    <span class="mobile-card-info-value">{{ wrap.size_str }}</span>
                </div>
            </div>
            <div class="mobile-card-actions" style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                <a href="{{ url_for('wraps.download_wrap', partition=wrap.partition_key, filename=wrap.filename) }}"
                   class="action-btn btn-success" style="flex: 1;">
                    ğŸ“¥ ä¸‹è½½
                </a>
                <form method="post" action="{{ url_for('wraps.delete_wrap', partition=wrap.partition_key, filename=wrap.filename) }}"
                      onsubmit="return confirm('æ‚¨ç¡®å®šè¦åˆ é™¤ {{ wrap.filename }}æ–‡ä»¶å—ï¼Ÿ');"
                      style="flex: 1; margin: 0; display: flex;">
                    <button type="submit" class="action-btn btn-danger" style="width: 100%;">ğŸ—‘ï¸ åˆ é™¤</button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="info-box">
        <p>è´´çº¸æ–‡ä»¶å¤¹ä¸­æœªæ‰¾åˆ°è‡ªå®šä¹‰è´´çº¸æ–‡ä»¶ã€‚</p>
        <p style="margin-top: 10px; font-size: 13px; color: var(--text-secondary);">
            åœ¨å–·æ¼†è½¦é—´ä¸Šä¼  PNG æ–‡ä»¶ï¼Œå³å¯è‡ªå®šä¹‰ç‰¹æ–¯æ‹‰çš„ 3D è½¦è¾†å¯è§†åŒ–æ•ˆæœã€‚
        </p>
    </div>
    {% endif %}
</div>

<script>
// Validation constants from server
const MAX_FILE_SIZE = {{ max_file_size }};
const MIN_DIMENSION = {{ min_dimension }};
const MAX_DIMENSION = {{ max_dimension }};
const MAX_FILENAME_LENGTH = {{ max_filename_length }};
const MAX_WRAP_COUNT = {{ max_wrap_count }};
const CURRENT_WRAP_COUNT = {{ wrap_count }};

// Device and capability detection
function isMobileDevice() {
    return /(iPad|iPhone|iPod|Android|Mobile)/i.test(navigator.userAgent) ||
           window.matchMedia("(max-width: 768px)").matches;
}

function isIOS() {
    return /(iPad|iPhone|iPod)/i.test(navigator.userAgent) && !window.MSStream;
}

function isSafari() {
    var ua = navigator.userAgent;
    return /Safari/i.test(ua) && !/Chrome|CriOS|EdgiOS|FxiOS|OPiOS/i.test(ua);
}

function supportsMultipleUpload() {
    const input = document.createElement('input');
    return 'multiple' in input && !isIOS();
}

// Initialize upload interface based on device capabilities
document.addEventListener('DOMContentLoaded', function() {
    const isMobile = isMobileDevice();
    const supportsMulti = supportsMultipleUpload();

    const desktopInterface = document.getElementById('desktopUploadInterface');
    const mobileForm = document.getElementById('wrapUploadForm');
    const iosWarning = document.getElementById('iosWarning');
    const uploadControls = document.getElementById('wrapUploadControls');

    // Show iOS warning if needed
    if (isIOS() && !isSafari()) {
        if (iosWarning) iosWarning.style.display = 'block';
        if (uploadControls) uploadControls.style.display = 'none';
        return;
    }

    // Show appropriate interface
    if (!isMobile && supportsMulti) {
        // Desktop: show drag-drop interface
        if (desktopInterface) desktopInterface.style.display = 'block';
        if (mobileForm) mobileForm.style.display = 'none';
        initializeDragDrop();
    } else {
        // Mobile/iOS: show simple form (already visible by default)
        if (desktopInterface) desktopInterface.style.display = 'none';
        if (mobileForm) mobileForm.style.display = 'block';
        initializeSimpleUpload();
    }
});

// Multi-file upload state
let selectedFiles = [];
let fileValidationResults = new Map(); // Store validation results

function initializeDragDrop() {
    const dropZone = document.getElementById('dragDropZone');
    const fileInput = document.getElementById('wrap_files_multi');
    const uploadBtn = document.getElementById('uploadSelectedBtn');
    const clearBtn = document.getElementById('clearSelectedBtn');

    if (!dropZone || !fileInput) return;

    // Click to browse
    dropZone.addEventListener('click', function() {
        fileInput.click();
    });

    // File input change
    fileInput.addEventListener('change', function(e) {
        handleFiles(Array.from(e.target.files));
    });

    // Drag and drop events
    dropZone.addEventListener('dragenter', function(e) {
        e.preventDefault();
        e.stopPropagation();
        dropZone.style.borderColor = 'var(--btn-purple-bg)';
        dropZone.style.background = 'var(--hover-bg, rgba(111, 66, 193, 0.1))';
    });

    dropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
    });

    dropZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        e.stopPropagation();
        dropZone.style.borderColor = 'var(--border-input)';
        dropZone.style.background = 'var(--form-input-bg)';
    });

    dropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        dropZone.style.borderColor = 'var(--border-input)';
        dropZone.style.background = 'var(--form-input-bg)';

        const files = Array.from(e.dataTransfer.files);
        handleFiles(files);
    });

    // Upload button
    if (uploadBtn) {
        uploadBtn.addEventListener('click', function() {
            uploadMultipleFiles();
        });
    }

    // Clear button
    if (clearBtn) {
        clearBtn.addEventListener('click', function() {
            selectedFiles = [];
            fileValidationResults.clear();
            updateFilesList();
        });
    }
}

async function handleFiles(files) {
    // Filter for PNG files only
    const pngFiles = files.filter(file => {
        const ext = '.' + file.name.split('.').pop().toLowerCase();
        return ext === '.png' || file.type === 'image/png';
    });

    if (pngFiles.length === 0) {
        alert('è¯·ä»…é€‰æ‹© PNG æ–‡ä»¶ä¸Šä¼ ã€‚');
        return;
    }

    // Check if we'd exceed max count
    const remainingSlots = MAX_WRAP_COUNT - CURRENT_WRAP_COUNT - selectedFiles.length;
    if (remainingSlots <= 0) {
        alert(`æœ€å¤šå…è®¸ä½¿ç”¨ ${MAX_WRAP_COUNT} ä¸ªè´´çº¸ã€‚ æ‚¨ç›®å‰å·²ä½¿ç”¨ ${CURRENT_WRAP_COUNT} ä¸ªè´´çº¸ã€‚`);
        return;
    }

    // Process each file
    for (const file of pngFiles) {
        // Check for duplicates
        const exists = selectedFiles.some(f => f.name === file.name && f.size === file.size);
        if (exists) continue;

        // Validate and add file
        const validation = await validateFile(file);
        fileValidationResults.set(file.name + '_' + file.size, validation);

        selectedFiles.push(file);

        // Check remaining slots
        if (selectedFiles.length >= remainingSlots) {
            if (pngFiles.indexOf(file) < pngFiles.length - 1) {
                alert(`ä»…å‰© ${remainingSlots} ä¸ªç©ºä½ã€‚éƒ¨åˆ†æ–‡ä»¶æœªèƒ½æ·»åŠ ã€‚`);
            }
            break;
        }
    }

    updateFilesList();
}

async function validateFile(file) {
    const errors = [];
    let dimensions = null;

    // Check file extension and name
    const baseName = file.name.replace(/\.png$/i, '');
    if (baseName.length > MAX_FILENAME_LENGTH) {
        errors.push(`æ–‡ä»¶åè¿‡é•¿ï¼Œ(${baseName.length}/${MAX_FILENAME_LENGTH} ä¸ªå­—ç¬¦)`);
    }

    const validPattern = /^[a-zA-Z0-9_\- ]+$/;
    if (!validPattern.test(baseName)) {
        errors.push('æ–‡ä»¶åä¸­åŒ…å«æ— æ•ˆå­—ç¬¦ã€‚');
    }

    // Check file size
    if (file.size > MAX_FILE_SIZE) {
        const sizeMB = (file.size / 1024 / 1024).toFixed(2);
        errors.push(`æ–‡ä»¶è¿‡å¤§ (${sizeMB} MB, æœ€å¤§ 1 MB)`);
    }

    // Check dimensions by loading image
    try {
        dimensions = await getImageDimensions(file);
        if (dimensions) {
            if (dimensions.width < MIN_DIMENSION || dimensions.height < MIN_DIMENSION) {
                errors.push(`å°ºå¯¸è¿‡å° (${dimensions.width}x${dimensions.height}, æœ€å°ä¸º ${MIN_DIMENSION}x${MIN_DIMENSION})`);
            }
            if (dimensions.width > MAX_DIMENSION || dimensions.height > MAX_DIMENSION) {
                errors.push(`å°ºå¯¸è¿‡å¤§ ( ${dimensions.width}x${dimensions.height}, æœ€å¤§ä¸º ${MAX_DIMENSION}x${MAX_DIMENSION})`);
            }
        }
    } catch (e) {
        errors.push('æ— æ³•è¯»å–å›¾åƒå°ºå¯¸ã€‚');
    }

    return {
        valid: errors.length === 0,
        errors: errors,
        dimensions: dimensions
    };
}

function getImageDimensions(file) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        const url = URL.createObjectURL(file);

        img.onload = function() {
            URL.revokeObjectURL(url);
            resolve({ width: img.width, height: img.height });
        };

        img.onerror = function() {
            URL.revokeObjectURL(url);
            reject(new Error('åŠ è½½å›¾ç‰‡å¤±è´¥ã€‚'));
        };

        img.src = url;
    });
}

function updateFilesList() {
    const preview = document.getElementById('selectedFilesPreview');
    const filesList = document.getElementById('filesList');
    const uploadBtn = document.getElementById('uploadSelectedBtn');

    if (!preview || !filesList) return;

    if (selectedFiles.length === 0) {
        preview.style.display = 'none';
        return;
    }

    preview.style.display = 'block';

    let html = '';
    let hasValidFiles = false;

    selectedFiles.forEach((file, index) => {
        const sizeKB = (file.size / 1024).toFixed(1);
        const sizeStr = `${sizeKB} KB`;
        const key = file.name + '_' + file.size;
        const validation = fileValidationResults.get(key);

        const isValid = validation && validation.valid;
        if (isValid) hasValidFiles = true;

        const statusIcon = isValid ? 'âœ“' : 'âš ï¸';
        const statusColor = isValid ? 'var(--success-text, #28a745)' : 'var(--error-text, #dc3545)';
        const borderColor = isValid ? 'var(--border-input)' : 'var(--error-text, #dc3545)';

        let dimStr = '';
        if (validation && validation.dimensions) {
            dimStr = ` (${validation.dimensions.width}x${validation.dimensions.height})`;
        }

        html += `
            <div style="display: flex; flex-direction: column; padding: 10px; border-bottom: 1px solid ${borderColor}; color: var(--text-primary);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1; overflow: hidden;">
                        <span style="color: ${statusColor}; margin-right: 8px;">${statusIcon}</span>
                        <strong style="word-break: break-word;">${escapeHtml(file.name)}</strong>
                        <span style="color: var(--text-secondary); font-size: 12px; margin-left: 8px;">${sizeStr}${dimStr}</span>
                    </div>
                    <button type="button" onclick="removeFile(${index})" style="background: none; border: none; color: var(--error-text, #dc3545); cursor: pointer; padding: 4px 8px; font-size: 18px; flex-shrink: 0;" title="Remove">âœ–</button>
                </div>
        `;

        if (validation && validation.errors.length > 0) {
            html += `
                <div style="margin-top: 5px; font-size: 12px; color: var(--error-text, #dc3545); padding-left: 24px;">
                    ${validation.errors.map(e => escapeHtml(e)).join('<br>')}
                </div>
            `;
        }

        html += '</div>';
    });

    filesList.innerHTML = html;

    // Disable upload button if no valid files
    if (uploadBtn) {
        uploadBtn.disabled = !hasValidFiles;
    }
}

function removeFile(index) {
    const file = selectedFiles[index];
    const key = file.name + '_' + file.size;
    fileValidationResults.delete(key);
    selectedFiles.splice(index, 1);
    updateFilesList();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function uploadMultipleFiles() {
    // Filter to only valid files
    const validFiles = selectedFiles.filter(file => {
        const key = file.name + '_' + file.size;
        const validation = fileValidationResults.get(key);
        return validation && validation.valid;
    });

    if (validFiles.length === 0) {
        alert('æ²¡æœ‰å¯ä¸Šä¼ çš„æœ‰æ•ˆæ–‡ä»¶ã€‚è¯·å…ˆä¿®å¤éªŒè¯é”™è¯¯ã€‚');
        return;
    }

    const uploadBtn = document.getElementById('uploadSelectedBtn');
    const clearBtn = document.getElementById('clearSelectedBtn');
    const progressDiv = document.getElementById('wrapUploadProgress');
    const progressBar = document.getElementById('wrapProgressBar');
    const statusText = document.getElementById('wrapUploadStatus');

    // Disable buttons
    if (uploadBtn) uploadBtn.disabled = true;
    if (clearBtn) clearBtn.disabled = true;

    // Show progress
    if (progressDiv) {
        progressDiv.style.display = 'block';
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';
        statusText.textContent = 'æ­£åœ¨å‡†å¤‡ä¸Šä¼ ...';
    }

    const formData = new FormData();
    validFiles.forEach(file => {
        formData.append('wrap_files', file);
    });

    try {
        const xhr = new XMLHttpRequest();

        // Track progress
        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                const percentComplete = Math.round((e.loaded / e.total) * 100);
                progressBar.style.width = percentComplete + '%';
                progressBar.textContent = percentComplete + '%';

                const loadedKB = (e.loaded / 1024).toFixed(1);
                const totalKB = (e.total / 1024).toFixed(1);
                statusText.textContent = `æ­£åœ¨ä¸Šä¼  ${validFiles.length} ä¸ªæ–‡ä»¶... (${loadedKB} KB / ${totalKB} KB)`;
            }
        });

        // Handle completion
        xhr.addEventListener('load', function() {
            if (xhr.status === 200) {
                try {
                    const response = JSON.parse(xhr.responseText);

                    progressBar.style.width = '100%';
                    progressBar.textContent = '100%';
                    progressBar.style.background = '#28a745';

                    if (response.success) {
                        statusText.textContent = response.summary || 'ä¸Šä¼ å®Œæˆï¼';
                        statusText.style.color = '#28a745';

                        // Show detailed results
                        showUploadResults(response.results);

                        // Clear selections and reload after delay
                        setTimeout(function() {
                            selectedFiles = [];
                            fileValidationResults.clear();
                            window.location.reload();
                        }, 2000);
                    } else {
                        statusText.textContent = 'ä¸Šä¼ å®Œæˆï¼Œä½†å‡ºç°é”™è¯¯ã€‚';
                        statusText.style.color = '#ffc107';
                        showUploadResults(response.results);

                        // Re-enable buttons
                        if (uploadBtn) uploadBtn.disabled = false;
                        if (clearBtn) clearBtn.disabled = false;
                    }
                } catch (e) {
                    progressBar.style.background = '#dc3545';
                    statusText.textContent = 'ä¸Šä¼ å®Œæˆï¼æ­£åœ¨è·³è½¬...';
                    statusText.style.color = '#28a745';
                    setTimeout(function() {
                        window.location.reload();
                    }, 1000);
                }
            } else {
                progressBar.style.background = '#dc3545';
                statusText.textContent = 'Upload failed: ' + xhr.statusText;
                statusText.style.color = '#dc3545';
                if (uploadBtn) uploadBtn.disabled = false;
                if (clearBtn) clearBtn.disabled = false;
            }
        });

        // Handle errors
        xhr.addEventListener('error', function() {
            progressBar.style.background = '#dc3545';
            statusText.textContent = 'ä¸Šä¼ å¤±è´¥ï¼šç½‘ç»œé”™è¯¯ã€‚';
            statusText.style.color = '#dc3545';
            if (uploadBtn) uploadBtn.disabled = false;
            if (clearBtn) clearBtn.disabled = false;
        });

        // Send request
        xhr.open('POST', '{{ url_for("wraps.upload_multiple_wraps") }}');
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        xhr.send(formData);

    } catch (error) {
        console.error('Upload error:', error);
        alert('Upload failed: ' + error.message);
        if (uploadBtn) uploadBtn.disabled = false;
        if (clearBtn) clearBtn.disabled = false;
    }
}

function showUploadResults(results) {
    if (!results || results.length === 0) return;

    let html = '<div style="margin-top: 15px; padding: 10px; background: var(--form-input-bg); border-radius: 4px;"><strong>Upload Results:</strong><ul style="margin: 10px 0 0 20px; padding: 0;">';

    results.forEach(result => {
        const icon = result.success ? 'âœ“' : 'âœ—';
        const color = result.success ? '#28a745' : '#dc3545';
        const dimInfo = result.dimensions ? ` (${result.dimensions})` : '';
        html += `<li style="color: ${color}; margin: 5px 0;">${icon} ${escapeHtml(result.filename)}${dimInfo}: ${escapeHtml(result.message)}</li>`;
    });

    html += '</ul></div>';

    const statusText = document.getElementById('wrapUploadStatus');
    if (statusText && statusText.parentNode) {
        const resultsDiv = document.createElement('div');
        resultsDiv.innerHTML = html;
        statusText.parentNode.appendChild(resultsDiv);
    }
}

function initializeSimpleUpload() {
    const form = document.getElementById('wrapUploadForm');
    if (!form) return;

    const fileInput = document.getElementById('wrap_file');

    // Add client-side validation on file select
    if (fileInput) {
        fileInput.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const validation = await validateFile(file);
            if (!validation.valid) {
                alert('æ–‡ä»¶éªŒè¯å¤±è´¥:\nâ€¢ ' + validation.errors.join('\nâ€¢ '));
                fileInput.value = '';
            }
        });
    }

    form.addEventListener('submit', function(e) {
        e.preventDefault();

        const uploadBtn = document.getElementById('wrapUploadBtn');
        const progressDiv = document.getElementById('wrapUploadProgress');
        const progressBar = document.getElementById('wrapProgressBar');
        const statusText = document.getElementById('wrapUploadStatus');

        if (!fileInput.files || fileInput.files.length === 0) {
            alert('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶ã€‚');
            return;
        }

        const file = fileInput.files[0];
        const formData = new FormData(form);

        // Disable upload button and show progress
        uploadBtn.disabled = true;
        uploadBtn.textContent = 'â³ æ­£åœ¨ä¸Šä¼ ...';
        progressDiv.style.display = 'block';

        // Create AJAX request with progress tracking
        const xhr = new XMLHttpRequest();

        // Track upload progress
        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                const percentComplete = Math.round((e.loaded / e.total) * 100);
                progressBar.style.width = percentComplete + '%';
                progressBar.textContent = percentComplete + '%';

                // Format file size display
                const loadedKB = (e.loaded / 1024).toFixed(1);
                const totalKB = (e.total / 1024).toFixed(1);
                statusText.textContent = `æ­£åœ¨ä¸Šä¼  ${file.name}... (${loadedKB} KB / ${totalKB} KB)`;
            }
        });

        // Handle completion
        xhr.addEventListener('load', function() {
            if (xhr.status === 200 || xhr.status === 302) {
                progressBar.style.width = '100%';
                progressBar.textContent = '100%';
                progressBar.style.background = '#28a745';
                statusText.textContent = 'ä¸Šä¼ å®Œæˆï¼æ­£åœ¨é‡å®šå‘......';
                statusText.style.color = '#28a745';

                // Redirect after short delay
                setTimeout(function() {
                    window.location.reload();
                }, 1000);
            } else {
                progressBar.style.background = '#dc3545';
                statusText.textContent = 'ä¸Šä¼ å¤±è´¥: ' + xhr.statusText;
                statusText.style.color = '#dc3545';
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'ğŸ“¤ ä¸Šä¼ ';
            }
        });

        // Handle errors
        xhr.addEventListener('error', function() {
            progressBar.style.background = '#dc3545';
            statusText.textContent = 'ä¸Šä¼ å¤±è´¥ï¼šç½‘ç»œé”™è¯¯';
            statusText.style.color = '#dc3545';
            uploadBtn.disabled = false;
            uploadBtn.textContent = 'ğŸ“¤ ä¸Šä¼ ';
        });

        // Send the request
        xhr.open('POST', form.action);
        xhr.send(formData);
    });
}

// iOS Browser Detection and Warning Display
(function() {
    // Show warning and hide controls if iOS + not Safari
    if (isIOS() && !isSafari()) {
        var warning = document.getElementById('iosWarning');
        var controls = document.getElementById('wrapUploadControls');
        if (warning) warning.style.display = 'block';
        if (controls) controls.style.display = 'none';
    }
})();
</script>
{% endblock %}
